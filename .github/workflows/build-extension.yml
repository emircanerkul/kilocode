name: Build Extension Artifact
on:
  # Allows you to run this manually from the Actions tab
  workflow_dispatch:
  # Optional: Also run on PRs to ensure the build works
  pull_request:

env:
  NODE_VERSION: 20.20.0
  PNPM_VERSION: 10.8.1

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Create .env file
        # Required because the build script checks for .env inside the package
        run: echo "KILOCODE_POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}" >> .env

      - name: Package Extension
        id: package
        run: |
            current_package_version=$(node -p "require('./src/package.json').version")
            echo "version=${current_package_version}" >> $GITHUB_OUTPUT
            
            # Build the VSIX (This generates the zip/vsix file)
            pnpm vsix:production

            # --- Validation Steps (From your original workflow) ---
            # Save VSIX contents to a temporary file to verify integrity
            unzip -l bin/kilo-code-${current_package_version}.vsix > /tmp/kilo-code-vsix-contents.txt

            # Check for required files
            grep -q "extension/package.json" /tmp/kilo-code-vsix-contents.txt || exit 1
            grep -q "extension/dist/extension.js" /tmp/kilo-code-vsix-contents.txt || exit 1
            grep -q ".env" /tmp/kilo-code-vsix-contents.txt || exit 1

            # Clean up temporary file
            rm /tmp/kilo-code-vsix-contents.txt
            
            echo "Build and verification successful."

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v6
        with:
            name: kilo-code-extension-${{ steps.package.outputs.version }}
            path: bin/kilo-code-${{ steps.package.outputs.version }}.vsix
            retention-days: 5
